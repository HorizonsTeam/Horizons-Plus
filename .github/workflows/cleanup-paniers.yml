name: Cleanup expired paniers

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Cleanup expired paniers
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          psql "$DATABASE_URL" -c "
          UPDATE panier
          SET statut = 'EXPIRE'
          WHERE statut = 'ACTIF'
            AND expire_le <= NOW();

          DELETE FROM panier
          WHERE statut = 'EXPIRE'
            AND expire_le < NOW() - INTERVAL '30 days';
          "
